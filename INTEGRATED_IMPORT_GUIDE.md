# 📊 통합 가져오기 기능 사용 가이드

## ✅ 완료된 기능

### 🎯 통합 엑셀 파일 업로드 기능
엑셀/CSV 파일에서 **현장(Sites)**, **건물(Buildings)**, **장비(Equipment)** 데이터를 **한 번에 가져올 수 있는 기능**이 추가되었습니다!

---

## 📋 사용 방법

### 1️⃣ 페이지 접속
**URL**: https://noyorc.github.io/hvac-management/excel-import.html

### 2️⃣ "통합 가져오기" 탭 선택
- 페이지 상단에 4개의 탭이 있습니다:
  - 현장 데이터
  - 건물 데이터
  - 장비 데이터
  - **통합 가져오기** ⬅️ 여기를 클릭!

### 3️⃣ 통합 템플릿 다운로드
- **"통합 템플릿 다운로드"** 버튼을 클릭합니다.
- `통합_데이터_템플릿.xlsx` 파일이 다운로드됩니다.
- 이 파일에는 **3개의 시트**가 포함되어 있습니다:
  - **Sites** 시트
  - **Buildings** 시트
  - **Equipment** 시트

### 4️⃣ 엑셀 파일 작성

#### 📍 Sites 시트 (현장 정보)
| 컬럼명 | 필수 여부 | 설명 | 예시 |
|--------|----------|------|------|
| id | ✅ 필수 | 현장 고유 ID | SITE001 |
| site_name | ✅ 필수 | 현장 이름 | 강남 오피스 빌딩 |
| address | ✅ 필수 | 주소 | 서울특별시 강남구 테헤란로 123 |
| contact_name | ✅ 필수 | 담당자 이름 | 김철수 |
| contact_phone | ✅ 필수 | 담당자 전화번호 | 02-1234-5678 |

#### 🏢 Buildings 시트 (건물 정보)
| 컬럼명 | 필수 여부 | 설명 | 예시 |
|--------|----------|------|------|
| id | ✅ 필수 | 건물 고유 ID | BLD001 |
| site_id | ✅ 필수 | 소속 현장 ID | SITE001 |
| building_name | ✅ 필수 | 건물 이름 | A동 |
| floors | ✅ 필수 | 층수 | 15 |

#### ⚙️ Equipment 시트 (장비 정보)
| 컬럼명 | 필수 여부 | 설명 | 예시 |
|--------|----------|------|------|
| id | ✅ 필수 | 장비 고유 ID | EQ0001 |
| equipment_id | ✅ 필수 | 장비 식별 번호 | EQ0001 |
| site_id | ✅ 필수 | 소속 현장 ID | SITE001 |
| building_id | ✅ 필수 | 소속 건물 ID | BLD001 |
| equipment_type | ✅ 필수 | 장비 유형 | 냉동기 |
| model | ✅ 필수 | 모델명 | ABC-1000 |
| location | ✅ 필수 | 설치 위치 | 기계실 |
| floor | ⚠️ 선택 | 설치 층 | B1 |
| capacity | ⚠️ 선택 | 용량 | 500RT |

### 5️⃣ 파일 업로드
- **드래그 앤 드롭**: 파일을 박스 안으로 끌어다 놓기
- **파일 선택**: "파일 선택" 버튼 클릭 후 파일 선택

### 6️⃣ 미리보기 확인
- 업로드 후 각 시트의 **처음 10개 데이터**가 미리보기로 표시됩니다.
- 데이터가 올바른지 확인합니다.

### 7️⃣ Firestore에 저장
- **"Firestore에 저장 (Sites → Buildings → Equipment 순서)"** 버튼을 클릭합니다.
- 진행률 표시줄이 나타나며 저장 상태를 보여줍니다.
- 완료 메시지가 표시되면 성공입니다!

---

## 🎯 데이터 구조 규칙

### 현장별 번호 체계
사용자가 요청한 대로 **현장(Site)별로 장비 번호를 쉽게 구분**할 수 있도록 설계되었습니다:

#### 📌 SITE001 (강남 오피스 빌딩)
- **건물**: BLD001 ~ BLD010 (10개)
- **장비**: EQ0001 ~ EQ0999 (1,000개)
- **규칙**: 장비 번호가 `EQ0xxx`이면 SITE001 소속

#### 📌 SITE002 (판교 테크노밸리)
- **건물**: BLD011 ~ BLD020 (10개)
- **장비**: EQ1000 ~ EQ1999 (1,000개)
- **규칙**: 장비 번호가 `EQ1xxx`이면 SITE002 소속

#### 📌 SITE003 (부산 센터)
- **건물**: BLD021 ~ BLD030 (10개)
- **장비**: EQ2000 ~ EQ2999 (1,000개)
- **규칙**: 장비 번호가 `EQ2xxx`이면 SITE003 소속

### 🔢 번호 패턴 공식
```
SITE 번호: SITE001, SITE002, SITE003, ...
건물 번호: BLD(001 + (사이트번호-1)*10) ~ BLD(010 + (사이트번호-1)*10)
장비 번호: EQ(0000 + (사이트번호-1)*1000) ~ EQ(0999 + (사이트번호-1)*1000)
```

**예시**:
- SITE005의 장비는 **EQ4000 ~ EQ4999**
- SITE010의 장비는 **EQ9000 ~ EQ9999**
- SITE011의 장비는 **EQ10000 ~ EQ10999**

---

## 🚀 처리 순서

시스템은 **참조 무결성**을 보장하기 위해 다음 순서로 데이터를 저장합니다:

1. **Sites** → Firestore `sites` 컬렉션에 저장
2. **Buildings** → Firestore `buildings` 컬렉션에 저장 (site_id 참조)
3. **Equipment** → Firestore `equipment` 컬렉션에 저장 (site_id, building_id 참조)

각 단계가 완료된 후 다음 단계로 진행하므로 **데이터 일관성이 보장**됩니다.

---

## ⚡ 성능 정보

### 배치 처리
- 한 번에 **50개씩** 배치로 처리합니다.
- 대량 데이터도 안정적으로 업로드할 수 있습니다.

### 예상 처리 시간
| 현장 수 | 건물 수 | 장비 수 | 예상 시간 |
|---------|---------|---------|----------|
| 3 | 30 | 300 | 약 30초 |
| 10 | 100 | 10,000 | 약 3분 |
| 50 | 500 | 50,000 | 약 15분 |

---

## 📊 실시간 진행률 표시

업로드 중에는 다음 정보가 실시간으로 표시됩니다:
- 📦 **현재 처리 중인 단계** (Sites / Buildings / Equipment)
- 📈 **진행률 바** (퍼센트)
- 🔢 **처리된 개수** / 전체 개수
- ✅ **각 단계 완료 메시지**

---

## 💡 주요 기능

### ✨ 자동 기능
1. **자동 타임스탬프 추가**: `created_at` 필드가 자동으로 추가됩니다.
2. **데이터 유효성 검사**: 필수 필드가 누락되면 오류 메시지를 표시합니다.
3. **중복 방지**: 동일한 ID로 기존 데이터를 덮어씁니다 (업데이트).
4. **숫자 자동 변환**: 문자열로 입력된 숫자를 자동으로 Number 타입으로 변환합니다.

### 🛡️ 오류 처리
- 업로드 중 오류가 발생하면:
  - 콘솔(F12)에 상세한 오류 메시지가 표시됩니다.
  - 오류가 발생한 행 번호와 이유를 확인할 수 있습니다.
  - 오류 수정 후 다시 업로드하면 됩니다.

---

## 🔄 기존 데이터와의 관계

### 데이터 병합
- **기존 데이터 유지**: 기존 Firestore 데이터는 그대로 유지됩니다.
- **중복 ID 처리**: 같은 ID가 있으면 **새 데이터로 업데이트**됩니다.
- **추가 데이터**: 새로운 ID는 **추가**됩니다.

### 데이터 삭제
기존 데이터를 완전히 삭제하고 새로 시작하려면:
1. **데이터 삭제 페이지**: https://noyorc.github.io/hvac-management/delete-firestore-data.html
2. 또는 **구조화 데이터 생성 도구**: https://noyorc.github.io/hvac-management/structured-data-generator.html
   - "모든 데이터 삭제" 버튼 사용

⚠️ **주의**: 삭제된 데이터는 복구할 수 없습니다!

---

## 🔗 관련 페이지 링크

| 페이지 | URL | 설명 |
|--------|-----|------|
| 통합 가져오기 | https://noyorc.github.io/hvac-management/excel-import.html | 엑셀/CSV 데이터 업로드 |
| 구조화 데이터 생성 | https://noyorc.github.io/hvac-management/structured-data-generator.html | 테스트 데이터 자동 생성 |
| 관리자 페이지 | https://noyorc.github.io/hvac-management/admin.html | 데이터 관리 |
| 대시보드 | https://noyorc.github.io/hvac-management/dashboard.html | 통계 및 차트 |
| 데이터 삭제 | https://noyorc.github.io/hvac-management/delete-firestore-data.html | 모든 데이터 삭제 |

---

## 🎓 사용 예시

### 시나리오: 3개 현장의 데이터 업로드

#### 1단계: 템플릿 다운로드 및 작성
통합 템플릿을 다운로드하여 3개 시트에 데이터를 입력합니다:

**Sites 시트**:
```
id       | site_name         | address                    | contact_name | contact_phone
---------|-------------------|----------------------------|--------------|---------------
SITE001  | 강남 오피스 빌딩   | 서울특별시 강남구 테헤란로   | 김철수       | 02-1234-5678
SITE002  | 판교 테크노밸리    | 경기도 성남시 분당구        | 이영희       | 031-9876-5432
SITE003  | 부산 센터         | 부산광역시 해운대구         | 박민수       | 051-1111-2222
```

**Buildings 시트**:
```
id       | site_id | building_name | floors
---------|---------|---------------|-------
BLD001   | SITE001 | A동           | 15
BLD002   | SITE001 | B동           | 12
BLD011   | SITE002 | 본관          | 20
BLD012   | SITE002 | 별관          | 8
BLD021   | SITE003 | 1관           | 10
```

**Equipment 시트**:
```
id      | equipment_id | site_id | building_id | equipment_type | model      | location | floor | capacity
--------|--------------|---------|-------------|----------------|------------|----------|-------|----------
EQ0001  | EQ0001       | SITE001 | BLD001      | 냉동기         | ABC-1000   | 기계실   | B1    | 500RT
EQ0002  | EQ0002       | SITE001 | BLD001      | 보일러         | XYZ-500    | 기계실   | B1    | 300kW
EQ1000  | EQ1000       | SITE002 | BLD011      | 냉동기         | ABC-2000   | 옥상     | RF    | 800RT
EQ2000  | EQ2000       | SITE003 | BLD021      | 냉각탑         | DEF-1500   | 옥상     | RF    | 1000RT
```

#### 2단계: 파일 업로드
- `통합_데이터_템플릿.xlsx` 파일을 저장합니다.
- 통합 가져오기 페이지에서 파일을 드래그 앤 드롭합니다.

#### 3단계: 미리보기 확인
- Sites: 3개
- Buildings: 5개
- Equipment: 4개
- 데이터가 올바르게 표시되는지 확인합니다.

#### 4단계: 저장
- "Firestore에 저장" 버튼을 클릭합니다.
- 진행률 표시:
  - ✅ Sites 저장 완료 (3/3)
  - ✅ Buildings 저장 완료 (5/5)
  - ✅ Equipment 저장 완료 (4/4)
  - 🎉 모든 데이터 저장 완료!

---

## 🆚 비교: 개별 vs 통합 가져오기

### 개별 가져오기 (기존 방식)
1. 현장 데이터 탭 → 파일 업로드 → 저장
2. 건물 데이터 탭 → 파일 업로드 → 저장
3. 장비 데이터 탭 → 파일 업로드 → 저장

**총 3번의 파일 업로드 + 3번의 저장 작업 = 6단계**

### 통합 가져오기 (신규 방식) ⭐
1. 통합 가져오기 탭 → 1개 파일 업로드 → 1번 저장

**1번의 파일 업로드 + 1번의 저장 작업 = 2단계**

✅ **작업 단계 67% 감소!**

---

## ❓ 자주 묻는 질문 (FAQ)

### Q1: 엑셀 파일 대신 CSV 파일도 사용할 수 있나요?
**A**: 네! `.csv` 파일도 지원합니다. 다만, CSV는 한 번에 1개 시트만 포함할 수 있으므로 **개별 가져오기 탭**을 사용해야 합니다. 통합 가져오기는 **엑셀(.xlsx)** 파일만 지원합니다.

### Q2: 데이터가 이미 있는데 추가로 업로드하면 어떻게 되나요?
**A**: 
- **같은 ID**: 기존 데이터가 **새 데이터로 업데이트**됩니다.
- **다른 ID**: 새로운 데이터로 **추가**됩니다.

### Q3: 업로드 중 오류가 발생하면 어떻게 하나요?
**A**: 
1. 브라우저 콘솔(F12)을 엽니다.
2. 오류 메시지에서 **문제가 있는 행 번호**와 **이유**를 확인합니다.
3. 엑셀 파일에서 해당 행을 수정합니다.
4. 다시 업로드합니다.

### Q4: 장비 번호를 자유롭게 정할 수 있나요?
**A**: 네! 권장 규칙은 다음과 같지만 필수는 아닙니다:
- SITE001 → EQ0001~EQ0999
- SITE002 → EQ1000~EQ1999
- 원하시는 번호 체계를 사용하셔도 됩니다.

### Q5: 한글이 깨져서 나와요!
**A**: 엑셀 파일을 저장할 때 **UTF-8 인코딩**으로 저장하세요:
1. 엑셀에서 "다른 이름으로 저장"
2. 파일 형식: "CSV UTF-8(쉼표로 분리)(*.csv)"

### Q6: 몇 개까지 업로드할 수 있나요?
**A**: 이론적으로는 제한이 없지만, 안정성을 위해:
- **권장**: 현장 100개, 건물 1,000개, 장비 10,000개 이하
- **최대**: 현장 500개, 건물 5,000개, 장비 50,000개

더 많은 데이터는 여러 번에 나눠서 업로드하는 것을 권장합니다.

---

## 🎉 완료!

이제 엑셀 파일 하나로 **현장, 건물, 장비 데이터를 한 번에 가져올 수 있습니다!**

필요한 추가 기능이나 문제가 있으면 언제든지 말씀해주세요! 😊
