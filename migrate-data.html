<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ - Google Sheets â†’ Firebase</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #667eea;
            text-align: center;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .progress {
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .data-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .data-summary h3 {
            margin-top: 0;
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .data-item:last-child {
            border-bottom: none;
        }
        .count {
            font-weight: bold;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</h1>
        <p style="text-align: center;">Google Apps Script â†’ Firebase Firestore</p>

        <div class="warning">
            <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong>
            <ul>
                <li>ì´ ì‘ì—…ì€ <strong>ê¸°ì¡´ Google Sheets ë°ì´í„°</strong>ë¥¼ Firebaseë¡œ ë³µì‚¬í•©ë‹ˆë‹¤</li>
                <li>Firebaseì— <strong>ì´ë¯¸ ìˆëŠ” ë°ì´í„°ëŠ” ë®ì–´ì“°ê¸°</strong> ë©ë‹ˆë‹¤</li>
                <li>ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ì—ëŠ” í˜ì´ì§€ë¥¼ <strong>ìƒˆë¡œê³ ì¹¨í•˜ì§€ ë§ˆì„¸ìš”</strong></li>
                <li>ì™„ë£Œê¹Œì§€ <strong>1-5ë¶„</strong> ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            </ul>
        </div>

        <button class="btn" onclick="checkData()">1ï¸âƒ£ ê¸°ì¡´ ë°ì´í„° í™•ì¸í•˜ê¸°</button>
        
        <div id="dataSummary" class="data-summary" style="display: none;">
            <h3>ğŸ“Š ê¸°ì¡´ ë°ì´í„° í˜„í™©</h3>
            <div id="summaryContent"></div>
        </div>

        <button class="btn" id="migrateBtn" onclick="startMigration()" disabled style="display: none;">
            2ï¸âƒ£ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘í•˜ê¸°
        </button>

        <div id="progress" class="progress">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill">0%</div>
            </div>
            <p id="progressText" style="text-align: center; margin-top: 10px;"></p>
        </div>

        <div id="status" class="status"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSvObiEPfQkEfSLRzyg2BdCCJmQENJs8ic",
            authDomain: "hvac-management-477fb.firebaseapp.com",
            projectId: "hvac-management-477fb",
            storageBucket: "hvac-management-477fb.firebasestorage.app",
            messagingSenderId: "812239966797",
            appId: "1:812239966797:web:b454d99fde982328f7dea04",
            measurementId: "G-f14YESP0P1"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.firebaseReady = true;
    </script>
    <script src="js/firebase-config.js"></script>

    <script>
        const API_BASE = 'https://script.google.com/macros/s/AKfycbzKnOxwx-AY4fg_bT88wHfR6w3BIbAytWnl8wrQ_MdSRj39LSYRYueDgx8Hl-RC1Jybuw/exec';
        let existingData = {};

        // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
        function waitForFirebase() {
            return new Promise((resolve) => {
                if (window.db && window.FirestoreHelper) {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (window.db && window.FirestoreHelper) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                }
            });
        }

        async function checkData() {
            await waitForFirebase();
            
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status info';
            statusDiv.innerHTML = 'â³ Google Sheets ë°ì´í„°ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...';

            try {
                // ê° í…Œì´ë¸” ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const tables = ['sites', 'buildings', 'equipment', 'inspectors', 'inspections'];
                
                for (const table of tables) {
                    statusDiv.innerHTML += `<br>ğŸ“¥ ${table} ë°ì´í„° ë¡œë”© ì¤‘...`;
                    const response = await fetch(`${API_BASE}?action=list&table=${table}`);
                    const data = await response.json();
                    existingData[table] = data.data || [];
                }

                // ë°ì´í„° ìš”ì•½ í‘œì‹œ
                const summaryDiv = document.getElementById('dataSummary');
                const summaryContent = document.getElementById('summaryContent');
                
                summaryContent.innerHTML = `
                    <div class="data-item">
                        <span>ğŸ“ í˜„ì¥ (Sites)</span>
                        <span class="count">${existingData.sites.length}ê°œ</span>
                    </div>
                    <div class="data-item">
                        <span>ğŸ¢ ê±´ë¬¼ (Buildings)</span>
                        <span class="count">${existingData.buildings.length}ê°œ</span>
                    </div>
                    <div class="data-item">
                        <span>âš™ï¸ ì¥ë¹„ (Equipment)</span>
                        <span class="count">${existingData.equipment.length}ê°œ</span>
                    </div>
                    <div class="data-item">
                        <span>ğŸ‘· ì ê²€ì (Inspectors)</span>
                        <span class="count">${existingData.inspectors.length}ëª…</span>
                    </div>
                    <div class="data-item">
                        <span>ğŸ“‹ ì ê²€ ê¸°ë¡ (Inspections)</span>
                        <span class="count">${existingData.inspections.length}ê°œ</span>
                    </div>
                `;

                summaryDiv.style.display = 'block';
                document.getElementById('migrateBtn').style.display = 'block';
                document.getElementById('migrateBtn').disabled = false;

                statusDiv.className = 'status success';
                statusDiv.innerHTML = 'âœ… ë°ì´í„° í™•ì¸ ì™„ë£Œ! ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹œì‘í•˜ì„¸ìš”.';

            } catch (error) {
                console.error('Error:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `âŒ <strong>ì˜¤ë¥˜ ë°œìƒ:</strong><br>${error.message}<br><br>Google Sheets APIê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`;
            }
        }

        async function startMigration() {
            await waitForFirebase();
            
            const statusDiv = document.getElementById('status');
            const progressDiv = document.getElementById('progress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const migrateBtn = document.getElementById('migrateBtn');

            // UI ì—…ë°ì´íŠ¸
            migrateBtn.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.className = 'status info';
            statusDiv.innerHTML = 'ğŸš€ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤...';
            progressDiv.style.display = 'block';

            try {
                const tables = ['sites', 'buildings', 'equipment', 'inspectors', 'inspections'];
                const totalTables = tables.length;
                let currentTable = 0;

                for (const tableName of tables) {
                    currentTable++;
                    const progress = Math.round((currentTable / totalTables) * 100);
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                    
                    progressText.innerHTML = `ğŸ“¦ ${tableName} ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘... (${currentTable}/${totalTables})`;
                    statusDiv.innerHTML = `â³ ${tableName} í…Œì´ë¸” ì²˜ë¦¬ ì¤‘...`;

                    const data = existingData[tableName];

                    // 1. ê¸°ì¡´ Firebase ë°ì´í„° ì‚­ì œ
                    statusDiv.innerHTML += `<br>ğŸ—‘ï¸ ê¸°ì¡´ ${tableName} ë°ì´í„° í™•ì¸ ì¤‘...`;
                    const existingFirebaseData = await window.FirestoreHelper.getAllDocuments(tableName);
                    
                    if (existingFirebaseData.data && existingFirebaseData.data.length > 0) {
                        statusDiv.innerHTML += ` (${existingFirebaseData.data.length}ê°œ ë°œê²¬)`;
                        // Firebase Helperë¡œëŠ” ì‚­ì œê°€ ì•ˆë˜ë‹ˆ ì¼ë‹¨ ë®ì–´ì“°ê¸°ë§Œ í•¨
                    }

                    // 2. ìƒˆ ë°ì´í„° ì¶”ê°€
                    statusDiv.innerHTML += `<br>ğŸ“¥ ìƒˆ ${tableName} ë°ì´í„° ì¶”ê°€ ì¤‘... (${data.length}ê°œ)`;
                    
                    let successCount = 0;
                    for (const item of data) {
                        try {
                            // IDê°€ ìˆìœ¼ë©´ setDocument, ì—†ìœ¼ë©´ addDocument
                            if (item.id && (tableName !== 'inspections')) {
                                // inspectionsëŠ” ìë™ ID ì‚¬ìš©
                                const result = await window.FirestoreHelper.setDocument(tableName, item.id, item);
                                if (result.success) successCount++;
                            } else {
                                // inspections ë˜ëŠ” IDê°€ ì—†ëŠ” ê²½ìš°
                                const itemData = { ...item };
                                
                                // inspection_dateë¥¼ ISO ë¬¸ìì—´ë¡œ ìœ ì§€ (Firestoreì—ì„œ ìë™ ë³€í™˜ë¨)
                                const result = await window.FirestoreHelper.addDocument(tableName, itemData);
                                if (result.success) successCount++;
                            }
                        } catch (itemError) {
                            console.error(`Error adding item to ${tableName}:`, itemError);
                        }
                    }

                    statusDiv.innerHTML += `<br>âœ… ${tableName} ì™„ë£Œ! (${successCount}/${data.length}ê°œ ì¶”ê°€ë¨)`;
                }

                // ì™„ë£Œ
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                progressText.innerHTML = 'âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!';
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `
                    ğŸ‰ <strong>ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!</strong><br><br>
                    ğŸ“ í˜„ì¥: ${existingData.sites.length}ê°œ<br>
                    ğŸ¢ ê±´ë¬¼: ${existingData.buildings.length}ê°œ<br>
                    âš™ï¸ ì¥ë¹„: ${existingData.equipment.length}ê°œ<br>
                    ğŸ‘· ì ê²€ì: ${existingData.inspectors.length}ëª…<br>
                    ğŸ“‹ ì ê²€ ê¸°ë¡: ${existingData.inspections.length}ê°œ<br><br>
                    <strong>ëª¨ë“  ë°ì´í„°ê°€ Firebaseë¡œ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤!</strong><br><br>
                    <a href="index.html" style="color: #667eea; font-weight: bold;">ğŸ  ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™</a> |
                    <a href="dashboard.html" style="color: #667eea; font-weight: bold;">ğŸ“Š ëŒ€ì‹œë³´ë“œ í™•ì¸</a>
                `;

            } catch (error) {
                console.error('Migration Error:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `
                    âŒ <strong>ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:</strong><br>
                    ${error.message}<br><br>
                    <strong>ìƒì„¸ ì˜¤ë¥˜:</strong><br>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto;">${error.stack || 'No stack trace'}</pre><br>
                    ì¼ë¶€ ë°ì´í„°ë§Œ ì´ì „ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
                `;
                progressDiv.style.display = 'none';
            }
        }
    </script>
</body>
</html>
