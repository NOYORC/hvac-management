<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR ì½”ë“œ ìƒì„± - HVAC ê´€ë¦¬</title>    
    <!-- PWA Meta Tags -->
    <meta name="description" content="ê³µì¡°ì„¤ë¹„ ì ê²€ ë° ê´€ë¦¬ ì‹œìŠ¤í…œ">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HVAC ê´€ë¦¬">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .qr-generator-container {
            max-width: 900px;
            margin: 20px auto;
        }
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .equipment-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .equipment-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .equipment-card .equipment-id {
            background: #f0f0f0;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
            margin: 10px 0;
        }
        .qr-code-container {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .qr-code-container canvas {
            max-width: 100%;
            height: auto;
        }
        .btn-download {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn-print {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn-generate-all {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
        }
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="btn-back" onclick="location.href='index.html'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1><i class="fas fa-qrcode"></i> QR ì½”ë“œ ìƒì„±</h1>
        </div>

        <div class="qr-generator-container">
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                <strong>QR ì½”ë“œ ì¶œë ¥ ì•ˆë‚´</strong><br>
                ê° ì¥ë¹„ì˜ QR ì½”ë“œë¥¼ ìƒì„±í•˜ì—¬ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ì¸ì‡„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                ìƒì„±ëœ QR ì½”ë“œë¥¼ ì¥ë¹„ì— ë¶€ì°©í•˜ë©´ ë¹ ë¥´ê²Œ ì ê²€ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>

            <button class="btn-generate-all" onclick="generateAllQRCodes()">
                <i class="fas fa-magic"></i> ëª¨ë“  ì¥ë¹„ QR ì½”ë“œ ìƒì„±
            </button>

            <div id="equipmentList" class="equipment-grid">
                <p style="text-align: center; color: #666;">ì¥ë¹„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </div>

    <!-- QR Code Generator Library - ë¡œì»¬ íŒŒì¼ ì‚¬ìš© -->
    <script src="js/qrcode.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
                const firebaseConfig = {
            apiKey: "AIzaSyCpTEePTOkEfSLRzyszq0dCCJmQEWJsBic",
            authDomain: "hvac-management-477fb.firebaseapp.com",
            projectId: "hvac-management-477fb",
            storageBucket: "hvac-management-477fb.firebasestorage.app",
            messagingSenderId: "312239966797",
            appId: "1:312239966797:web:b454d99fde9823207dea04",
            measurementId: "G-FT4YE5FDP1"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // ì „ì—­ ë³€ìˆ˜ë¡œ ë…¸ì¶œ
        window.db = db;
        window.firestoreModules = { collection, getDocs, doc, getDoc };
        window.firebaseReady = true;
        
        console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
    </script>
    
    <script>
        let allEquipment = [];

        // ì¥ë¹„ ì•„ì´ì½˜ ë§¤í•‘
        function getEquipmentIcon(type) {
            const iconMap = {
                'AHU': 'fa-wind',
                'FCU': 'fa-fan',
                'ëƒ‰ë™ê¸°': 'fa-snowflake',
                'ëƒ‰ê°íƒ‘': 'fa-tower-broadcast',
                'PACKAGED AIR CONDITIONER UNIT': 'fa-box',
                'CHILLER': 'fa-temperature-low',
                'PUMP': 'fa-water',
                'BOILER': 'fa-fire'
            };
            return iconMap[type] || 'fa-cog';
        }

        // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
        async function waitForFirebase() {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (window.firebaseReady && window.db && window.firestoreModules) {
                        clearInterval(checkInterval);
                        console.log('âœ… Firebase ë¡œë“œ í™•ì¸ ì™„ë£Œ');
                        resolve();
                    }
                }, 100);
                
                // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
                setTimeout(() => {
                    clearInterval(checkInterval);
                    if (!window.firebaseReady) {
                        console.error('âŒ Firebase ë¡œë“œ íƒ€ì„ì•„ì›ƒ');
                        resolve(); // ì—ëŸ¬ë¡œ ì²˜ë¦¬í•˜ì§€ ì•Šê³  ê³„ì† ì§„í–‰
                    }
                }, 10000);
            });
        }

        // QR ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ëŒ€ê¸°
        function waitForQRCode() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 100; // 10ì´ˆ
                
                if (typeof QRCode !== 'undefined') {
                    console.log('âœ… QRCode ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¯¸ ë¡œë“œë¨');
                    resolve();
                    return;
                }
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (typeof QRCode !== 'undefined') {
                        clearInterval(checkInterval);
                        console.log('âœ… QRCode ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.error('âŒ QRCode ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨ (10ì´ˆ íƒ€ì„ì•„ì›ƒ)');
                        console.warn('âš ï¸ QR ì½”ë“œ ìƒì„± ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.');
                        resolve(); // ê³„ì† ì§„í–‰
                    }
                }, 100);
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¥ë¹„ ëª©ë¡ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ“„ í˜ì´ì§€ ë¡œë“œ ì‹œì‘...');
            
            try {
                await waitForFirebase();
                await waitForQRCode();
                await loadEquipmentList();
            } catch (error) {
                console.error('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                document.getElementById('equipmentList').innerHTML = 
                    '<p style="text-align: center; color: #dc3545;">ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</p>';
            }
        });

        async function loadEquipmentList() {
            const listContainer = document.getElementById('equipmentList');
            
            try {
                console.log('ğŸ” ì¥ë¹„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹œì‘...');
                
                if (!window.db) {
                    throw new Error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                if (!window.firestoreModules) {
                    throw new Error('Firestore ëª¨ë“ˆì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                // Firestoreì—ì„œ ì¥ë¹„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const { collection, getDocs } = window.firestoreModules;
                const querySnapshot = await getDocs(collection(window.db, 'equipment'));
                
                allEquipment = [];
                querySnapshot.forEach((doc) => {
                    allEquipment.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log('âœ… Firebase ì‘ë‹µ ì„±ê³µ');
                console.log('ğŸ“¦ ì¥ë¹„ ìˆ˜:', allEquipment.length);
                
                if (allEquipment.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; color: #666;">ë“±ë¡ëœ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.<br><small>migrate-data.htmlì—ì„œ ë°ì´í„°ë¥¼ ë§ˆì´ê·¸ë ˆì´ì…˜ í•´ì£¼ì„¸ìš”.</small></p>';
                    return;
                }

                listContainer.innerHTML = '';
                
                allEquipment.forEach((equipment, index) => {
                    console.log(`ğŸ“ ì¥ë¹„ ${index + 1} ì¹´ë“œ ìƒì„±:`, equipment.id);
                    
                    const card = document.createElement('div');
                    card.className = 'equipment-card';
                    card.id = `card-${equipment.id}`;
                    card.innerHTML = `
                        <h3><i class="fas ${getEquipmentIcon(equipment.equipment_type)}"></i> ${equipment.equipment_type || 'ì•Œ ìˆ˜ ì—†ìŒ'}</h3>
                        <div class="equipment-id">${equipment.id}</div>
                        <p><i class="fas fa-map-marker-alt"></i> ${equipment.floor || '-'} - ${equipment.location || '-'}</p>
                        <p><i class="fas fa-box"></i> ${equipment.model || '-'}</p>
                        <div class="qr-code-container" id="qr-${equipment.id}">
                            <!-- QR ì½”ë“œê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                        </div>
                        <button class="btn-download" onclick="downloadQRCode('${equipment.id}', '${equipment.equipment_type || 'equipment'}')">
                            <i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button class="btn-print" onclick="printQRCode('${equipment.id}')">
                            <i class="fas fa-print"></i> ì¸ì‡„
                        </button>
                    `;
                    listContainer.appendChild(card);
                });
                
                console.log('âœ… ëª¨ë“  ì¥ë¹„ ì¹´ë“œ ìƒì„± ì™„ë£Œ');

            } catch (error) {
                console.error('âŒ ì¥ë¹„ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                listContainer.innerHTML = 
                    `<p style="text-align: center; color: #dc3545;">
                        ì¥ë¹„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
                        <small>ì˜¤ë¥˜: ${error.message}</small><br>
                        <small>Console(F12)ì—ì„œ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.</small>
                    </p>`;
            }
        }

        async function generateAllQRCodes() {
            // QR ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
            if (typeof QRCode === 'undefined') {
                alert('âŒ QR ì½”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨(Ctrl+Shift+R) í•´ì£¼ì„¸ìš”.');
                console.error('QRCode library not loaded');
                return;
            }

            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìƒì„± ì¤‘...';

            try {
                let successCount = 0;
                let failCount = 0;
                
                for (const equipment of allEquipment) {
                    try {
                        await generateQRCode(equipment.id);
                        successCount++;
                        // ê° QR ì½”ë“œ ìƒì„± í›„ ì§§ì€ ì§€ì—° (ë Œë”ë§ì„ ìœ„í•´)
                        await new Promise(resolve => setTimeout(resolve, 50));
                    } catch (error) {
                        console.error(`QR ìƒì„± ì‹¤íŒ¨ (${equipment.id}):`, error);
                        failCount++;
                    }
                }

                if (failCount > 0) {
                    button.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${successCount}ê°œ ìƒì„± (${failCount}ê°œ ì‹¤íŒ¨)`;
                } else {
                    button.innerHTML = '<i class="fas fa-check"></i> ìƒì„± ì™„ë£Œ!';
                }
                
                console.log(`âœ… QR ì½”ë“œ ìƒì„± ì™„ë£Œ: ì„±ê³µ ${successCount}ê°œ, ì‹¤íŒ¨ ${failCount}ê°œ`);
                
                // 3ì´ˆ í›„ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì›ë˜ëŒ€ë¡œ
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-magic"></i> ëª¨ë“  ì¥ë¹„ QR ì½”ë“œ ìƒì„±';
                }, 3000);
            } catch (error) {
                console.error('QR ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ìƒì„± ì‹¤íŒ¨';
                alert('QR ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
            }
        }

        async function generateQRCode(equipmentId) {
            const container = document.getElementById(`qr-${equipmentId}`);
            if (!container) {
                console.error(`Container not found: qr-${equipmentId}`);
                return;
            }
            
            // ê¸°ì¡´ QR ì½”ë“œ ì œê±°
            container.innerHTML = '<p style="color: #999; font-size: 12px;">ìƒì„± ì¤‘...</p>';

            try {
                // QRCodeJS ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ QR ì½”ë“œ ìƒì„±
                if (typeof QRCode === 'undefined') {
                    throw new Error('QRCode ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
                container.innerHTML = '';
                
                // QR ì½”ë“œ ìƒì„±
                const qr = new QRCode(container, {
                    text: equipmentId,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.M
                });
                
                // ìƒì„±ëœ ì´ë¯¸ì§€ì— ID ì¶”ê°€ (ë‹¤ìš´ë¡œë“œìš©)
                setTimeout(() => {
                    const img = container.querySelector('img');
                    if (img) {
                        img.id = `qr-img-${equipmentId}`;
                        img.alt = `QR Code for ${equipmentId}`;
                    }
                }, 100);

            } catch (error) {
                console.error(`QR ì½”ë“œ ìƒì„± ì˜¤ë¥˜ (${equipmentId}):`, error);
                container.innerHTML = `<p style="color: #dc3545; font-size: 12px;">ìƒì„± ì‹¤íŒ¨<br><small>${error.message}</small></p>`;
                throw error; // ìƒìœ„ë¡œ ì—ëŸ¬ ì „íŒŒ
            }
        }

        function downloadQRCode(equipmentId, equipmentType) {
            const img = document.getElementById(`qr-img-${equipmentId}`);
            if (!img) {
                alert('QR ì½”ë“œë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œ
            const link = document.createElement('a');
            link.download = `QR_${equipmentId}_${equipmentType}.png`;
            link.href = img.src;
            link.click();
        }

        function printQRCode(equipmentId) {
            const card = document.getElementById(`card-${equipmentId}`);
            if (!card) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>QR ì½”ë“œ ì¸ì‡„ - ${equipmentId}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            text-align: center;
                            padding: 20px;
                        }
                        h2 { color: #667eea; }
                        .equipment-info {
                            margin: 10px 0;
                            font-size: 14px;
                        }
                        canvas {
                            margin: 20px 0;
                        }
                        @media print {
                            button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${card.innerHTML}
                    <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; margin-top: 20px;">ì¸ì‡„í•˜ê¸°</button>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
    </script>
</body>
</html>
