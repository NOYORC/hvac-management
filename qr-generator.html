<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR 코드 생성 - HVAC 관리</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .qr-generator-container {
            max-width: 900px;
            margin: 20px auto;
        }
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .equipment-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .equipment-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .equipment-card .equipment-id {
            background: #f0f0f0;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
            margin: 10px 0;
        }
        .qr-code-container {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .qr-code-container canvas {
            max-width: 100%;
            height: auto;
        }
        .btn-download {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn-print {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn-generate-all {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
        }
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="btn-back" onclick="location.href='index.html'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1><i class="fas fa-qrcode"></i> QR 코드 생성</h1>
        </div>

        <div class="qr-generator-container">
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                <strong>QR 코드 출력 안내</strong><br>
                각 장비의 QR 코드를 생성하여 다운로드하거나 인쇄할 수 있습니다.<br>
                생성된 QR 코드를 장비에 부착하면 빠르게 점검을 시작할 수 있습니다.
            </div>

            <button class="btn-generate-all" onclick="generateAllQRCodes()">
                <i class="fas fa-magic"></i> 모든 장비 QR 코드 생성
            </button>

            <div id="equipmentList" class="equipment-grid">
                <p style="text-align: center; color: #666;">장비 목록을 불러오는 중...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSvObiEPfQkEfSLRzyg2BdCCJmQENJs8ic",
            authDomain: "hvac-management-477fb.firebaseapp.com",
            projectId: "hvac-management-477fb",
            storageBucket: "hvac-management-477fb.firebasestorage.app",
            messagingSenderId: "812239966797",
            appId: "1:812239966797:web:b454d99fde982328f7dea04",
            measurementId: "G-f14YESP0P1"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
    </script>

    <script src="js/firebase-config.js"></script>
    <script src="js/main.js"></script>
    
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <script>
        let allEquipment = [];

        // 장비 아이콘 매핑
        function getEquipmentIcon(type) {
            const iconMap = {
                'AHU': 'fa-wind',
                'FCU': 'fa-fan',
                '냉동기': 'fa-snowflake',
                '냉각탑': 'fa-tower-broadcast',
                'PACKAGED AIR CONDITIONER UNIT': 'fa-box',
                'CHILLER': 'fa-temperature-low',
                'PUMP': 'fa-water',
                'BOILER': 'fa-fire'
            };
            return iconMap[type] || 'fa-cog';
        }

        // Firebase 초기화 대기
        async function waitForFirebase() {
            return new Promise((resolve) => {
                if (window.db && window.FirestoreHelper) {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (window.db && window.FirestoreHelper) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                }
            });
        }

        // QR 라이브러리 로딩 대기
        function waitForQRCode() {
            return new Promise((resolve) => {
                if (typeof QRCode !== 'undefined') {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (typeof QRCode !== 'undefined') {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                }
            });
        }

        // 페이지 로드 시 장비 목록 로드
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('페이지 로드 시작...');
            
            try {
                await waitForFirebase();
                console.log('Firebase 로드 완료');
                
                await waitForQRCode();
                console.log('QRCode 라이브러리 로드 완료');
                
                await loadEquipmentList();
                console.log('장비 목록 로드 완료');
            } catch (error) {
                console.error('초기화 오류:', error);
                document.getElementById('equipmentList').innerHTML = 
                    '<p style="text-align: center; color: #dc3545;">초기화 중 오류가 발생했습니다: ' + error.message + '</p>';
            }
        });

        async function loadEquipmentList() {
            const listContainer = document.getElementById('equipmentList');
            
            try {
                console.log('장비 목록 가져오기 시작...');
                
                if (!window.FirestoreHelper) {
                    throw new Error('FirestoreHelper가 로드되지 않았습니다.');
                }
                
                const result = await window.FirestoreHelper.getAllDocuments('equipment');
                console.log('Firebase 응답:', result);
                
                allEquipment = result.data || [];
                console.log('장비 수:', allEquipment.length);
                
                if (allEquipment.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; color: #666;">등록된 장비가 없습니다.</p>';
                    return;
                }

                listContainer.innerHTML = '';
                
                allEquipment.forEach((equipment, index) => {
                    console.log(`장비 ${index + 1} 카드 생성:`, equipment.id);
                    
                    const card = document.createElement('div');
                    card.className = 'equipment-card';
                    card.id = `card-${equipment.id}`;
                    card.innerHTML = `
                        <h3><i class="fas ${getEquipmentIcon(equipment.equipment_type)}"></i> ${equipment.equipment_type}</h3>
                        <div class="equipment-id">${equipment.id}</div>
                        <p><i class="fas fa-map-marker-alt"></i> ${equipment.floor || '-'} - ${equipment.location || '-'}</p>
                        <p><i class="fas fa-box"></i> ${equipment.model || '-'}</p>
                        <div class="qr-code-container" id="qr-${equipment.id}">
                            <!-- QR 코드가 여기에 생성됩니다 -->
                        </div>
                        <button class="btn-download" onclick="downloadQRCode('${equipment.id}', '${equipment.equipment_type}')">
                            <i class="fas fa-download"></i> 다운로드
                        </button>
                        <button class="btn-print" onclick="printQRCode('${equipment.id}')">
                            <i class="fas fa-print"></i> 인쇄
                        </button>
                    `;
                    listContainer.appendChild(card);
                });
                
                console.log('모든 장비 카드 생성 완료');

            } catch (error) {
                console.error('장비 목록 로드 오류:', error);
                listContainer.innerHTML = 
                    `<p style="text-align: center; color: #dc3545;">
                        장비 목록을 불러오는데 실패했습니다.<br>
                        <small>${error.message}</small>
                    </p>`;
            }
        }

        async function generateAllQRCodes() {
            // QR 라이브러리 확인
            if (typeof QRCode === 'undefined') {
                alert('QR 코드 라이브러리를 불러오는 중입니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 생성 중...';

            try {
                for (const equipment of allEquipment) {
                    await generateQRCode(equipment.id);
                    // 각 QR 코드 생성 후 짧은 지연 (렌더링을 위해)
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                button.innerHTML = '<i class="fas fa-check"></i> 생성 완료!';
                
                // 3초 후 버튼 텍스트 원래대로
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-magic"></i> 모든 장비 QR 코드 생성';
                }, 3000);
            } catch (error) {
                console.error('QR 코드 생성 중 오류:', error);
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 생성 실패';
                alert('QR 코드 생성 중 오류가 발생했습니다.');
            }
        }

        async function generateQRCode(equipmentId) {
            const container = document.getElementById(`qr-${equipmentId}`);
            if (!container) {
                console.error(`Container not found: qr-${equipmentId}`);
                return;
            }
            
            // 기존 QR 코드 제거
            container.innerHTML = '';

            try {
                // QR 코드를 데이터 URL로 생성
                const qrDataUrl = await QRCode.toDataURL(equipmentId, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                });

                // 이미지로 표시
                const img = document.createElement('img');
                img.src = qrDataUrl;
                img.id = `qr-img-${equipmentId}`;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.alt = `QR Code for ${equipmentId}`;
                
                container.appendChild(img);

            } catch (error) {
                console.error('QR 코드 생성 오류:', error);
                container.innerHTML = '<p style="color: #dc3545; font-size: 12px;">생성 실패</p>';
            }
        }

        function downloadQRCode(equipmentId, equipmentType) {
            const img = document.getElementById(`qr-img-${equipmentId}`);
            if (!img) {
                alert('QR 코드를 먼저 생성해주세요.');
                return;
            }

            // 이미지를 다운로드
            const link = document.createElement('a');
            link.download = `QR_${equipmentId}_${equipmentType}.png`;
            link.href = img.src;
            link.click();
        }

        function printQRCode(equipmentId) {
            const card = document.getElementById(`card-${equipmentId}`);
            if (!card) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>QR 코드 인쇄 - ${equipmentId}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            text-align: center;
                            padding: 20px;
                        }
                        h2 { color: #667eea; }
                        .equipment-info {
                            margin: 10px 0;
                            font-size: 14px;
                        }
                        canvas {
                            margin: 20px 0;
                        }
                        @media print {
                            button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${card.innerHTML}
                    <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; margin-top: 20px;">인쇄하기</button>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
    </script>
</body>
</html>
