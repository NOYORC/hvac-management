<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR ì½”ë“œ ìŠ¤ìº” - HVAC ê´€ë¦¬</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .scanner-container {
            max-width: 600px;
            margin: 20px auto;
            text-align: center;
        }
        #reader {
            border: 2px solid #667eea;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px auto;
            max-width: 100%;
        }
        .scanner-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
        .scanner-result {
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
            display: none;
        }
        .scanner-error {
            background: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
            display: none;
        }
        .equipment-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
            display: none;
        }
        .equipment-preview h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        .equipment-info {
            text-align: left;
            margin: 10px 0;
        }
        .equipment-info i {
            color: #667eea;
            width: 20px;
            margin-right: 10px;
        }
        .btn-start-inspection {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        .btn-start-inspection:hover {
            transform: scale(1.05);
        }
        .scan-again {
            background: #6c757d;
            color: white;
            padding: 10px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="btn-back" onclick="location.href='index.html'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1><i class="fas fa-qrcode"></i> QR ì½”ë“œ ìŠ¤ìº”</h1>
        </div>

        <div class="scanner-container">
            <div class="scanner-info">
                <i class="fas fa-info-circle"></i>
                <strong>QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶°ì£¼ì„¸ìš”</strong><br>
                ì¥ë¹„ì— ë¶€ì°©ëœ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ìë™ìœ¼ë¡œ ì ê²€ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.<br>
                <small style="color: #666; margin-top: 10px; display: block;">
                    âš ï¸ HTTP í™˜ê²½ì—ì„œëŠ” ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. HTTPS(GitHub Pages)ì—ì„œ ì‚¬ìš©í•˜ê±°ë‚˜, ì•„ë˜ ìˆ˜ë™ ì…ë ¥ì„ ì´ìš©í•˜ì„¸ìš”.
                </small>
            </div>

            <!-- ìˆ˜ë™ ì…ë ¥ ì˜µì…˜ ì¶”ê°€ -->
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <strong>ğŸ“ ì¥ë¹„ ID ìˆ˜ë™ ì…ë ¥</strong><br>
                <input type="text" id="manualEquipmentId" placeholder="ì¥ë¹„ ID ì…ë ¥ (ì˜ˆ: EQ001)" 
                    style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #667eea; border-radius: 5px; font-size: 16px;">
                <button onclick="loadEquipmentManually()" 
                    style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                    <i class="fas fa-search"></i> ì¥ë¹„ ì°¾ê¸°
                </button>
            </div>

            <div id="reader"></div>

            <div id="scannerResult" class="scanner-result">
                <i class="fas fa-check-circle"></i>
                <strong>QR ì½”ë“œ ì¸ì‹ ì„±ê³µ!</strong>
            </div>

            <div id="scannerError" class="scanner-error">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>ì˜¤ë¥˜ ë°œìƒ</strong><br>
                <span id="errorMessage"></span>
            </div>

            <div id="equipmentPreview" class="equipment-preview">
                <h3><i class="fas fa-wrench"></i> ìŠ¤ìº”ëœ ì¥ë¹„ ì •ë³´</h3>
                <div id="equipmentInfo"></div>
                <button class="btn-start-inspection" onclick="startInspection()">
                    <i class="fas fa-clipboard-check"></i> ì ê²€ ì‹œì‘í•˜ê¸°
                </button>
                <button class="scan-again" onclick="resetScanner()">
                    <i class="fas fa-redo"></i> ë‹¤ì‹œ ìŠ¤ìº”í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSvObiEPfQkEfSLRzyg2BdCCJmQENJs8ic",
            authDomain: "hvac-management-477fb.firebaseapp.com",
            projectId: "hvac-management-477fb",
            storageBucket: "hvac-management-477fb.firebasestorage.app",
            messagingSenderId: "812239966797",
            appId: "1:812239966797:web:b454d99fde982328f7dea04",
            measurementId: "G-f14YESP0P1"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
    </script>

    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <script src="js/firebase-config.js"></script>
    <script src="js/main.js"></script>
    <script>
        let html5QrCode;
        let scannedEquipmentId = null;
        let scannedEquipment = null;

        // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
        async function waitForFirebase() {
            return new Promise((resolve) => {
                if (window.db && window.FirestoreHelper) {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (window.db && window.FirestoreHelper) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                }
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤ìºë„ˆ ì‹œì‘
        document.addEventListener('DOMContentLoaded', async function() {
            await waitForFirebase();
            startScanner();
        });

        function startScanner() {
            html5QrCode = new Html5Qrcode("reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode.start(
                { facingMode: "environment" }, // í›„ë©´ ì¹´ë©”ë¼ ì‚¬ìš©
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error("ìŠ¤ìºë„ˆ ì‹œì‘ ì˜¤ë¥˜:", err);
                const readerDiv = document.getElementById('reader');
                readerDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 20px; border-radius: 8px; color: #721c24;">
                        <strong>âš ï¸ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</strong><br><br>
                        <p>ë‹¤ìŒ ì´ìœ  ì¤‘ í•˜ë‚˜ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>
                        <ul style="text-align: left;">
                            <li>HTTP í™˜ê²½ì—ì„œëŠ” ì¹´ë©”ë¼ ì ‘ê·¼ì´ ì œí•œë©ë‹ˆë‹¤</li>
                            <li>ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤</li>
                            <li>ë‹¤ë¥¸ ì•±ì´ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤</li>
                        </ul>
                        <p><strong>í•´ê²° ë°©ë²•:</strong></p>
                        <ul style="text-align: left;">
                            <li>âœ… GitHub Pages(HTTPS)ì—ì„œ ì ‘ì†í•˜ê¸°</li>
                            <li>âœ… ìœ„ì˜ <strong>ìˆ˜ë™ ì…ë ¥</strong> ì‚¬ìš©í•˜ê¸°</li>
                            <li>âœ… ë¸Œë¼ìš°ì € ì¹´ë©”ë¼ ê¶Œí•œ í™•ì¸í•˜ê¸°</li>
                        </ul>
                    </div>
                `;
            });
        }

        async function onScanSuccess(decodedText, decodedResult) {
            console.log(`QR ì½”ë“œ ìŠ¤ìº” ì„±ê³µ: ${decodedText}`);
            
            // ìŠ¤ìºë„ˆ ì¤‘ì§€
            html5QrCode.stop().then(() => {
                console.log("ìŠ¤ìºë„ˆ ì¤‘ì§€ë¨");
            }).catch(err => {
                console.error("ìŠ¤ìºë„ˆ ì¤‘ì§€ ì˜¤ë¥˜:", err);
            });

            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('scannerResult').style.display = 'block';
            
            // ì¥ë¹„ ì •ë³´ ì¡°íšŒ
            await loadEquipmentInfo(decodedText);
        }

        function onScanFailure(error) {
            // ìŠ¤ìº” ì‹¤íŒ¨ëŠ” ê³„ì† ì‹œë„í•˜ë¯€ë¡œ ë¡œê·¸ë§Œ ì¶œë ¥
            // console.warn(`QR ìŠ¤ìº” ì‹¤íŒ¨: ${error}`);
        }

        async function loadEquipmentInfo(equipmentId) {
            try {
                // Firebaseì—ì„œ ì¥ë¹„ ì •ë³´ ì¡°íšŒ
                const result = await window.FirestoreHelper.getDocument('equipment', equipmentId);
                
                if (result.success && result.data) {
                    scannedEquipment = result.data;
                    scannedEquipmentId = equipmentId;
                    
                    // ì¥ë¹„ ì •ë³´ í‘œì‹œ
                    const equipmentInfo = document.getElementById('equipmentInfo');
                    equipmentInfo.innerHTML = `
                        <div class="equipment-info">
                            <i class="fas fa-tag"></i>
                            <strong>ì¥ë¹„ ID:</strong> ${scannedEquipment.id}
                        </div>
                        <div class="equipment-info">
                            <i class="fas fa-wrench"></i>
                            <strong>ì¥ë¹„ ì¢…ë¥˜:</strong> ${scannedEquipment.equipment_type}
                        </div>
                        <div class="equipment-info">
                            <i class="fas fa-box"></i>
                            <strong>ëª¨ë¸:</strong> ${scannedEquipment.model}
                        </div>
                        <div class="equipment-info">
                            <i class="fas fa-map-marker-alt"></i>
                            <strong>ìœ„ì¹˜:</strong> ${scannedEquipment.floor} - ${scannedEquipment.location}
                        </div>
                        <div class="equipment-info">
                            <i class="fas fa-tachometer-alt"></i>
                            <strong>ìš©ëŸ‰:</strong> ${scannedEquipment.capacity}
                        </div>
                    `;
                    
                    document.getElementById('equipmentPreview').style.display = 'block';
                    document.getElementById('scannerResult').style.display = 'block';
                } else {
                    showError(`ì¥ë¹„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ID: ${equipmentId})`);
                }
            } catch (error) {
                console.error('ì¥ë¹„ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                showError('ì¥ë¹„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìˆ˜ë™ ì…ë ¥ìœ¼ë¡œ ì¥ë¹„ ê²€ìƒ‰
        async function loadEquipmentManually() {
            const equipmentId = document.getElementById('manualEquipmentId').value.trim();
            
            if (!equipmentId) {
                alert('ì¥ë¹„ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ìŠ¤ìºë„ˆ ì¤‘ì§€ (ì‹¤í–‰ ì¤‘ì´ë©´)
            if (html5QrCode && html5QrCode.isScanning) {
                try {
                    await html5QrCode.stop();
                } catch (err) {
                    console.log('ìŠ¤ìºë„ˆ ì¤‘ì§€:', err);
                }
            }
            
            // ì¥ë¹„ ì •ë³´ ë¡œë“œ
            await loadEquipmentInfo(equipmentId);
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('scannerError').style.display = 'block';
            
            // 5ì´ˆ í›„ ë‹¤ì‹œ ìŠ¤ìº”
            setTimeout(() => {
                resetScanner();
            }, 5000);
        }

        function startInspection() {
            if (scannedEquipmentId) {
                // ì ê²€ í˜ì´ì§€ë¡œ ì´ë™ (ì¥ë¹„ ID ì „ë‹¬)
                location.href = `inspection.html?equipmentId=${scannedEquipmentId}`;
            }
        }

        function resetScanner() {
            // UI ì´ˆê¸°í™”
            document.getElementById('scannerResult').style.display = 'none';
            document.getElementById('scannerError').style.display = 'none';
            document.getElementById('equipmentPreview').style.display = 'none';
            
            scannedEquipmentId = null;
            scannedEquipment = null;
            
            // ìŠ¤ìºë„ˆ ì¬ì‹œì‘
            startScanner();
        }

        // í˜ì´ì§€ ì´íƒˆ ì‹œ ìŠ¤ìºë„ˆ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (html5QrCode) {
                html5QrCode.stop().catch(err => console.error(err));
            }
        });
    </script>
</body>
</html>
