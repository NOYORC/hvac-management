<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì ê²€ì ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .log-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .log-success {
            background: #d4edda;
            color: #155724;
        }
        .log-warning {
            background: #fff3cd;
            color: #856404;
        }
        .log-error {
            background: #f8d7da;
            color: #721c24;
        }
        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .card h3 {
            color: #667eea;
            margin-top: 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
        }
        .stat-card .label {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‘· ì ê²€ì ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</h1>
        <p class="subtitle">êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ Firebaseë¡œ ì ê²€ì ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤</p>

        <div class="card">
            <h3>ğŸ“‹ ë§ˆì´ê·¸ë ˆì´ì…˜ ì •ë³´</h3>
            <p><strong>ì†ŒìŠ¤:</strong> êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ (Apps Script API)</p>
            <p><strong>ëŒ€ìƒ:</strong> Firebase Firestore - <code>inspectors</code> ì»¬ë ‰ì…˜</p>
            <p><strong>ì‘ì—…:</strong> ì ê²€ì ì´ë¦„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ë° ì €ì¥</p>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="number" id="totalCount">0</div>
                <div class="label">ì´ ì ê²€ì</div>
            </div>
            <div class="stat-card">
                <div class="number" id="successCount">0</div>
                <div class="label">ì„±ê³µ</div>
            </div>
            <div class="stat-card">
                <div class="number" id="errorCount">0</div>
                <div class="label">ì‹¤íŒ¨</div>
            </div>
        </div>

        <button class="btn" id="migrateBtn" onclick="migrateInspectors()">
            ğŸš€ ì ê²€ì ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘
        </button>

        <button class="btn" onclick="location.href='inspection.html'" style="background: #6c757d;">
            â† ì ê²€ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
        </button>

        <div class="log-container" id="logContainer"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, setDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSvObiEPfQkEfSLRzyg2BdCCJmQENJs8ic",
            authDomain: "hvac-management-477fb.firebaseapp.com",
            projectId: "hvac-management-477fb",
            storageBucket: "hvac-management-477fb.firebasestorage.app",
            messagingSenderId: "812239966797",
            appId: "1:812239966797:web:b454d99fde982328f7dea04",
            measurementId: "G-f14YESP0P1"
        };
        
        console.log('âœ… Firebase ì´ˆê¸°í™” ì‹œì‘...');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.firestoreModules = { collection, setDoc, doc, getDocs };
        console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
    </script>

    <script>
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbza7yPwDp_iUlQj1jyTi9h_z1Z40E0I3wBxELbhKGr9TjrCQaDTF7DCbGr8e1JC0VYDlQ/exec';

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }

        async function migrateInspectors() {
            const btn = document.getElementById('migrateBtn');
            btn.disabled = true;
            btn.textContent = 'â³ ë§ˆì´ê·¸ë ˆì´ì…˜ ì§„í–‰ ì¤‘...';

            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';

            const statsDiv = document.getElementById('stats');
            statsDiv.style.display = 'grid';

            let totalCount = 0;
            let successCount = 0;
            let errorCount = 0;

            try {
                addLog('ğŸ” êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ì ê²€ì ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...', 'info');

                // êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getInspectors`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                addLog(`ğŸ“Š ì‘ë‹µ ë°›ìŒ: ${JSON.stringify(result)}`, 'info');

                if (!result.success) {
                    throw new Error(result.message || 'ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }

                const inspectors = result.data;
                totalCount = inspectors.length;
                document.getElementById('totalCount').textContent = totalCount;

                addLog(`âœ… ì´ ${totalCount}ëª…ì˜ ì ê²€ì ë°ì´í„° ìˆ˜ì‹ `, 'success');

                // Firebaseì— ì €ì¥
                const { setDoc, doc } = window.firestoreModules;

                for (let i = 0; i < inspectors.length; i++) {
                    const inspector = inspectors[i];
                    
                    try {
                        const inspectorId = `INSP${String(i + 1).padStart(3, '0')}`;
                        const inspectorData = {
                            id: inspectorId,
                            inspector_name: inspector.inspector_name || inspector.name,
                            created_at: new Date().toISOString()
                        };

                        await setDoc(doc(window.db, 'inspectors', inspectorId), inspectorData);
                        
                        successCount++;
                        document.getElementById('successCount').textContent = successCount;
                        addLog(`âœ… ${successCount}/${totalCount}: ${inspectorData.inspector_name} ì €ì¥ ì™„ë£Œ`, 'success');
                    } catch (error) {
                        errorCount++;
                        document.getElementById('errorCount').textContent = errorCount;
                        addLog(`âŒ ${inspector.inspector_name || 'Unknown'} ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'error');
                    }
                }

                // ìµœì¢… ê²°ê³¼
                if (errorCount === 0) {
                    addLog(`ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ! ì´ ${successCount}ëª…ì˜ ì ê²€ì ì €ì¥ ì™„ë£Œ`, 'success');
                    btn.textContent = 'âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!';
                    btn.style.background = '#28a745';
                } else {
                    addLog(`âš ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ (ì„±ê³µ: ${successCount}, ì‹¤íŒ¨: ${errorCount})`, 'warning');
                    btn.textContent = 'âš ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ (ì¼ë¶€ ì‹¤íŒ¨)';
                    btn.style.background = '#ffc107';
                }

                // ì €ì¥ëœ ë°ì´í„° í™•ì¸
                setTimeout(async () => {
                    addLog('ğŸ” Firebaseì—ì„œ ì €ì¥ëœ ë°ì´í„° í™•ì¸ ì¤‘...', 'info');
                    const { collection, getDocs } = window.firestoreModules;
                    const snapshot = await getDocs(collection(window.db, 'inspectors'));
                    addLog(`ğŸ“Š Firebase inspectors ì»¬ë ‰ì…˜: ${snapshot.size}ê°œ ë¬¸ì„œ í™•ì¸`, 'success');
                    
                    snapshot.forEach(doc => {
                        addLog(`  - ${doc.id}: ${doc.data().inspector_name}`, 'info');
                    });
                }, 1000);

            } catch (error) {
                console.error('Migration error:', error);
                addLog(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                btn.textContent = 'âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨';
                btn.style.background = '#dc3545';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
